name: Convert MKV assets to MP4

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag of the release to process (e.g. v1.2.3)"
        required: true
        type: string

jobs:
  mkv-to-mp4:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1) Free disk space early
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          temp-reserve-mb: 1024
          swap-size-mb: 0
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Show free space
        run: df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq

      # 2) Get release info and assets for the chosen tag
      - name: Fetch release info
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          api="https://api.github.com"
          repo="${GITHUB_REPOSITORY}"
          tag="${{ inputs.release_tag }}"

          json=$(curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "$api/repos/$repo/releases/tags/$tag")

          echo "$json" > release.json

          upload_url=$(jq -r '.upload_url' release.json)
          assets_urls=$(jq -r '.assets[].browser_download_url' release.json)

          echo "upload_url=${upload_url%%\{*}" >> "$GITHUB_OUTPUT"
          printf "%s\n" $assets_urls > assets.txt

      # 3) Process assets one by one to keep disk usage low
      - name: Download, convert and upload each MKV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.release.outputs.upload_url }}
        run: |
          set -euo pipefail
          shopt -s nullglob

          while read -r url; do
            [ -z "$url" ] && continue

            file=$(basename "$url")
            echo "Downloading asset: $file"
            curl -L "$url" -o "$file"

            if [[ "$file" == *.mkv ]]; then
              mp4="${file%.mkv}.mp4"
              echo "Converting $file -> $mp4"

              # Copy only video + audio streams, exclude PGS subtitles (not supported in MP4)
              ffmpeg -y -i "$file" -map 0:v -map 0:a -c copy "$mp4"

              echo "Uploading $mp4"
              curl \
                -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Content-Type: video/mp4" \
                --data-binary @"$mp4" \
                "$UPLOAD_URL?name=$(basename "$mp4")"

              echo "Deleting local MKV and MP4 to free space"
              rm -f "$file" "$mp4"
            else
              echo "Skipping non-MKV asset: $file"
              rm -f "$file"
            fi

            echo "Disk usage after processing $file:"
            df -h
          done < assets.txt

      # Optional: extra cleanup
      - name: Final cleanup
        run: |
          rm -f release.json assets.txt || true
          df -h
