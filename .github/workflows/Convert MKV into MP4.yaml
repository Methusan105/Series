name: Convert MKV assets to MP4

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag of the release to process (e.g. v1.2.3)"
        required: true
        type: string

jobs:
  mkv-to-mp4:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1) Aggressive manual disk cleanup (replaces failing action)
      - name: Free disk space
        run: |
          # Remove swap file
          sudo swapoff /mnt/swapfile || true
          sudo rm -f /mnt/swapfile || true
          
          # Clean apt cache and lists
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          # Remove Docker and other large packages
          sudo docker system prune -a -f || true
          sudo rm -rf /usr/local/share/docker || true
          
          # Remove common large SDKs
          sudo rm -rf /usr/share/dotnet*
          sudo rm -rf /opt/android-sdk* /opt/android-emulator*
          sudo rm -rf /usr/lib/jvm/*
          sudo rm -rf /usr/local/haskell* /home/runner/.ghcup
          
          # Clean npm/yarn caches
          rm -rf ~/.npm ~/.yarn
          
          # Clean GitHub runner caches
          rm -rf ~/.cache/*
          
          echo "Disk space after cleanup:"
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl

      # 2) Get release info and assets for the chosen tag
      - name: Fetch release info
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          api="https://api.github.com"
          repo="${GITHUB_REPOSITORY}"
          tag="${{ inputs.release_tag }}"

          json=$(curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "$api/repos/$repo/releases/tags/$tag")

          echo "$json" > release.json

          upload_url=$(jq -r '.upload_url' release.json | sed 's/{.*//')
          assets_urls=$(jq -r '.assets[]? | select(.name | endswith(".mkv")) | .browser_download_url' release.json)

          echo "upload_url=${upload_url}" >> "$GITHUB_OUTPUT"
          printf "%s\n" $assets_urls > mkv_assets.txt

          echo "Found MKV files:"
          cat mkv_assets.txt

      # 3) Process each MKV one by one (minimal disk usage)
      - name: Convert and upload MKVs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.release.outputs.upload_url }}
        run: |
          set -euo pipefail

          if [ ! -f mkv_assets.txt ]; then
            echo "No MKV files found in release"
            exit 0
          fi

          total_files=$(wc -l < mkv_assets.txt)
          current=0

          while read -r url; do
            [ -z "$url" ] && continue
            
            current=$((current + 1))
            file=$(basename "$url")
            echo "=== Processing $current/$total_files: $file ==="

            # Download
            echo "Downloading $file..."
            curl -L -o "$file" "$url"

            # Convert (video + audio only, exclude PGS subtitles)
            mp4="${file%.mkv}.mp4"
            echo "Converting $file -> $mp4..."
            ffmpeg -y -i "$file" -map 0:v -map 0:a -c copy "$mp4" -loglevel error

            # Upload immediately
            echo "Uploading $mp4..."
            curl \
              -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: video/mp4" \
              --data-binary @"$mp4" \
              "$UPLOAD_URL?name=$(basename "$mp4")"

            # Clean up immediately to save space
            echo "Cleaning up $file and $mp4"
            rm -f "$file" "$mp4"

            echo "Disk usage after processing:"
            df -h .
          done < mkv_assets.txt

          echo "All files processed successfully!"

      # 4) Final cleanup
      - name: Final cleanup
        if: always()
        run: |
          rm -f release.json mkv_assets.txt || true
          df -h
